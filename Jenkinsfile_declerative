pipeline {
  agent any
  environment {
    KUBECONFIG = credentials('kubeconfig')
    DOKERHUB = credentials('duckerhub')
  }
  cleanWs()
  checkout scm
    stages {
        stage('build docker image') {
            steps {
              sh '''/bin/bash
                  set -e
                  bash update_website.sh $BUILD_NUMBER
                  docker login -u ${DOKERHUB_USR} -p ${DOKERHUB_PSW}
                  sudo docker build -t ${DOKERHUB_USR}/exam-webserver:$BUILD_NUMBER .
                  docker push ${DOKERHUB_USR}:exam-webserver:$BUILD_NUMBER
                  '''
            }
        }
        stage('deployment') {
            steps {
              withCredentials([string(credentialsId: 'kubeconfig', variable: 'kubeconfig')]){
                sh '''/bin/bash
                    set -e
                    echo ${KUBECONFIG} > .kubeconfig
                    export KUBECONFIG=.kubeconfig
                    helm upgrade exam-app danniel-app --set image.tag=$BUILD_NUMBER
                    '''
                }
            }
        }
    }
}
